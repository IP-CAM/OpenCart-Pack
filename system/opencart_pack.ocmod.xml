<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>OpenCart Pack</name>
  <code>valdeir_pack</code>
  <version>1.0</version>
  <author>Valdeir Psr</author>
  <link>http://www.valdeirsantana.com.br</link>
  <file path="catalog/view/theme/*/template/checkout/payment_address.tpl,catalog/view/theme/*/template/checkout/shipping_address.tpl">
  <operation>
      <search>
        <![CDATA[<option value="<?php echo $address['address_id']; ?>" selected="selected"><?php echo $address['firstname']; ?> <?php echo $address['lastname']; ?>, <?php echo $address['address_1']; ?>, <?php echo $address['city']; ?>, <?php echo $address['zone']; ?>, <?php echo $address['country']; ?></option>]]>
      </search>
      <add position="replace">
        <![CDATA[<option value="<?php echo $address['address_id']; ?>" selected="selected"><?php echo $address['firstname']; ?> <?php echo $address['lastname']; ?>, <?php echo $address['address_1']; ?>, <?php echo $address['custom_field'][5]; ?>, <?php echo $address['address_2'] ?>, <?php echo $address['city']; ?>, <?php echo $address['zone']; ?>, <?php echo $address['country']; ?></option>]]>
      </add>
    </operation>
  <operation>
      <search>
        <![CDATA[<option value="<?php echo $address['address_id']; ?>"><?php echo $address['firstname']; ?> <?php echo $address['lastname']; ?>, <?php echo $address['address_1']; ?>, <?php echo $address['city']; ?>, <?php echo $address['zone']; ?>, <?php echo $address['country']; ?></option>]]>
      </search>
      <add position="replace">
        <![CDATA[<option value="<?php echo $address['address_id']; ?>"><?php echo $address['firstname']; ?> <?php echo $address['lastname']; ?>, <?php echo $address['address_1']; ?>, <?php echo $address['custom_field'][5]; ?>, <?php echo $address['address_2'] ?>, <?php echo $address['city']; ?>, <?php echo $address['zone']; ?>, <?php echo $address['country']; ?></option>]]>
      </add>
    </operation>
  </file>



  <file path="admin/controller/sale/customer.php">
  <operation>
      <search>
        <![CDATA['location'           => $custom_field['location']]]>
      </search>
      <add position="replace"><![CDATA[
        'location'           => $custom_field['location'],
        'sort_order'         => $custom_field['sort_order']
      ]]></add>
    </operation>
  </file>
  <file path="admin/controller/sale/order.php">
    <operation>
      <search>
        <![CDATA['location'           => $custom_field['location']]]>
      </search>
      <add position="replace"><![CDATA[
        'location'           => $custom_field['location'],
        'sort_order'         => $custom_field['sort_order']
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA['value' => $upload_info['name']]]></search>
      <add position="replace"><![CDATA[
        'value' => $upload_info['name'],
        'sort_order' => $custom_field['sort_order']
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA['value' => $custom_field_value_info['name']]]></search>
      <add position="replace"><![CDATA[
        'value' => $custom_field_value_info['name'],
        'sort_order' => $custom_field['sort_order']
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA['value' => $order_info['shipping_custom_field'][$custom_field['custom_field_id']]]]></search>
      <add position="replace"><![CDATA[
        'value' => $order_info['shipping_custom_field'][$custom_field['custom_field_id']],
        'sort_order' => $custom_field['sort_order']
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA['value' => $order_info['payment_custom_field'][$custom_field['custom_field_id']]]]></search>
      <add position="replace"><![CDATA[
        'value' => $order_info['payment_custom_field'][$custom_field['custom_field_id']],
        'sort_order' => $custom_field['sort_order']
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$custom_fields = $this->model_sale_custom_field->getCustomFields();]]></search>
      <add position="replace"><![CDATA[
        $custom_fields = $this->model_sale_custom_field->getCustomFields(array('sort' => 'cf.sort_order'));
      ]]></add>
    </operation>

    <operation>
      <search><![CDATA[if ($order_info['payment_address_format']) {]]></search>
      <add position="before"><![CDATA[
        $this->load->model('sale/custom_field');
        $custom_fields = $this->model_sale_custom_field->getCustomFields();
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$payment_address = str_replace(array("\r\n", "\r", "\n"), '<br />', preg_replace(array("/\s\s+/", "/\r\r+/", "/\n\n+/"), '<br />', trim(str_replace($find, $replace, $format))));]]></search>
      <add position="before"><![CDATA[
        foreach ($custom_fields as $custom_field) {
          if (isset($order_info['payment_custom_field'][$custom_field['custom_field_id']])){
            $format = str_replace('{custom_field_' . $custom_field['custom_field_id'] . '}', $order_info['shipping_custom_field'][$custom_field['custom_field_id']], $format);
          }
        }
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$shipping_address = str_replace(array("\r\n", "\r", "\n"), '<br />', preg_replace(array("/\s\s+/", "/\r\r+/", "/\n\n+/"), '<br />', trim(str_replace($find, $replace, $format))));]]></search>
      <add position="before"><![CDATA[
        foreach ($custom_fields as $custom_field) {
          if (isset($order_info['shipping_custom_field'][$custom_field['custom_field_id']])){
            $format = str_replace('{custom_field_' . $custom_field['custom_field_id'] . '}', $order_info['shipping_custom_field'][$custom_field['custom_field_id']], $format);
          }
        }
      ]]></add>
    </operation>
  </file>



  <file path="admin/view/template/sale/customer_form.tpl">
    <operation>
      <search><![CDATA[<div class="form-group custom-field custom-field<?php echo $custom_field['custom_field_id']; ?>">]]></search>
      <add position="replace"><![CDATA[<div class="form-group custom-field custom-field<?php echo $custom_field['custom_field_id']; ?>" data-sort="<?php echo $custom_field['sort_order']; ?>">]]></add>
    </operation>
    <operation>
      <search><![CDATA[$('#tab-general .tab-content').append(html);]]></search>
      <add position="after"><![CDATA[
        $('#tab-address' + address_row + ' .form-group[data-sort]').detach().each(function() {
           if ($(this).attr('data-sort') >= 0 && $(this).attr('data-sort') <= $('#tab-address' + address_row + ' .form-group').length) {
             $('#tab-address' + address_row + ' .form-group').eq($(this).attr('data-sort')).before(this);
           }
        
           if ($(this).attr('data-sort') > $('#tab-address' + address_row + ' .form-group').length) {
             $('#tab-address' + address_row + ' .form-group:last').after(this);
           }
        
           if ($(this).attr('data-sort') < -$('#tab-address' + address_row + ' .form-group').length) {
             $('#tab-address' + address_row + ' .form-group:first').before(this);
           }
         });
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="before"><![CDATA[
        <script type="text/javascript"><!--
          <?php $address_row = 1; ?>
          <?php foreach ($addresses as $address) { ?>
          $('#tab-address<?php echo $address_row ?> .form-group[data-sort]').detach().each(function() {
           if ($(this).attr('data-sort') >= 0 && $(this).attr('data-sort') <= $('#tab-address<?php echo $address_row ?> .form-group').length) {
             $('#tab-address<?php echo $address_row ?> .form-group').eq($(this).attr('data-sort')).before(this);
           }
          
           if ($(this).attr('data-sort') > $('#tab-address<?php echo $address_row ?> .form-group').length) {
             $('#tab-address<?php echo $address_row ?> .form-group:last').after(this);
           }
          
           if ($(this).attr('data-sort') < -$('#tab-address<?php echo $address_row ?> .form-group').length) {
             $('#tab-address<?php echo $address_row ?> .form-group:first').before(this);
           }
          });
          <?php $address_row++; ?>
          <?php } ?>
          
          
          $('#tab-customer .form-group[data-sort]').detach().each(function() {
           if ($(this).attr('data-sort') >= 0 && $(this).attr('data-sort') <= $('#tab-customer .form-group').length) {

            console.log($(this).attr('data-sort'));

             $('#tab-customer .form-group').eq($(this).attr('data-sort')).before(this);
           }
          
           if ($(this).attr('data-sort') > $('#tab-customer .form-group').length) {
             $('#tab-customer .form-group:last').after(this);
           }
          
           if ($(this).attr('data-sort') < -$('#tab-customer .form-group').length) {
             $('#tab-customer .form-group:first').before(this);
           }
          });
        //--></script>
      ]]></add>
    </operation>
  </file>


  <file path="admin/view/template/sale/order_form.tpl">
    <operation>
      <search><![CDATA[<div class="form-group custom-field custom-field<?php echo $custom_field['custom_field_id']; ?>">]]></search>
      <add position="replace"><![CDATA[<div class="form-group custom-field custom-field<?php echo $custom_field['custom_field_id']; ?>" data-sort="<?php echo $custom_field['sort_order'] + 2; ?>">]]></add>
    </operation>
    <operation>
      <search><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="replace"><![CDATA[
        <script type="text/javascript"><!--
        // Sort the custom fields
        $('#tab-customer .form-group[data-sort]').detach().each(function() {
         if ($(this).attr('data-sort') >= 0 && $(this).attr('data-sort') <= $('#tab-customer .form-group').length) {
           $('#tab-customer .form-group').eq($(this).attr('data-sort')).before(this);
         }
        
         if ($(this).attr('data-sort') > $('#tab-customer .form-group').length) {
           $('#tab-customer .form-group:last').after(this);
         }
        
         if ($(this).attr('data-sort') < -$('#tab-customer .form-group').length) {
           $('#tab-customer .form-group:first').before(this);
         }
        });
        
        // Sort the custom fields
        $('#tab-payment .form-group[data-sort]').detach().each(function() {
        if ($(this).attr('data-sort') >= 0 && $(this).attr('data-sort') <= $('#tab-payment .form-group').length) {
           $('#tab-payment .form-group').eq(parseInt($(this).attr('data-sort') - 1)).before(this);
         }
        
         if ($(this).attr('data-sort') > $('#tab-payment .form-group').length) {
           $('#tab-payment .form-group:last').after(this);
         }
        
         if ($(this).attr('data-sort') < -$('#tab-payment .form-group').length) {
           $('#tab-payment .form-group:first').before(this);
         }
        });
        
        $('#tab-shipping .form-group[data-sort]').detach().each(function() {
         if ($(this).attr('data-sort') >= 0 && $(this).attr('data-sort') <= $('#tab-shipping .form-group').length) {
           $('#tab-shipping .form-group').eq(parseInt($(this).attr('data-sort') - 1)).before(this);
         }
        
         if ($(this).attr('data-sort') > $('#tab-shipping .form-group').length) {
           $('#tab-shipping .form-group:last').after(this);
         }
        
         if ($(this).attr('data-sort') < -$('#tab-shipping .form-group').length) {
           $('#tab-shipping .form-group:first').before(this);
         }
        });

        var payment_postcode = $('#tab-payment input[name="postcode"]').parent().parent().detach();
        $('#tab-payment input[name="address_1"]').parent().parent().before(payment_postcode);
        //--></script>
        ]]></add>
    </operation>
  </file>


  <file path="admin/view/template/sale/order_info.tpl">
    <operation>
      <search><![CDATA[<td><?php echo $custom_field['name']; ?>:</td>]]></search>
      <add position="replace" offset="-1"><![CDATA[<tr data-sort="<?php echo $custom_field['sort_order'] + 1; ?>">
                <td><?php echo $custom_field['name']; ?>:</td>]]></add>
    </operation>
    <operation>
      <search><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="before"><![CDATA[
        <script type="text/javascript"><!--
        // Sort the custom fields
        $('#tab-payment tr[data-sort]').detach().each(function() {
         if (parseInt($(this).attr('data-sort')) - 2 >= 0 && parseInt($(this).attr('data-sort')) - 2 <= $('#tab-payment tr').length) {
           $('#tab-payment tr').eq(parseInt($(this).attr('data-sort')) - 2).before(this);
         }
        
         if (parseInt($(this).attr('data-sort')) - 2 > $('#tab-payment tr').length) {
           $('#tab-payment tr:last').after(this);
         }
        
         if (parseInt($(this).attr('data-sort')) - 2 < -$('#tab-payment tr').length) {
           $('#tab-payment tr:first').before(this);
         }
        });
        
        $('#tab-shipping tr[data-sort]').detach().each(function() {
         if (parseInt($(this).attr('data-sort')) - 2 >= 0 && parseInt($(this).attr('data-sort')) - 2 <= $('#tab-shipping tr').length) {
           $('#tab-shipping tr').eq(parseInt($(this).attr('data-sort')) - 2).before(this);
         }
        
         if (parseInt($(this).attr('data-sort')) - 2 > $('#tab-shipping tr').length) {
           $('#tab-shipping tr:last').after(this);
         }
        
         if (parseInt($(this).attr('data-sort')) - 2 < -$('#tab-shipping tr').length) {
           $('#tab-shipping tr:first').before(this);
         }
        });
         //--></script>
      ]]></add>
    </operation>
  </file>

  <file path="catalog/model/checkout/order.php">
    <operation>
      <search><![CDATA[if ($order_info['payment_address_format']) {]]></search>
      <add position="before"><![CDATA[
        $this->load->model('account/custom_field');
        $custom_fields = $this->model_sale_custom_field->getCustomFields();
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$data['payment_address'] = str_replace(array("\r\n", "\r", "\n"), '<br />', preg_replace(array("/\s\s+/", "/\r\r+/", "/\n\n+/"), '<br />', trim(str_replace($find, $replace, $format))));]]></search>
      <add position="before"><![CDATA[
        foreach ($custom_fields as $custom_field) {
          if (isset($order_info['payment_custom_field'][$custom_field['custom_field_id']])){
            $format = str_replace('{custom_field_' . $custom_field['custom_field_id'] . '}', $order_info['shipping_custom_field'][$custom_field['custom_field_id']], $format);
          }
        }
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$data['shipping_address'] = str_replace(array("\r\n", "\r", "\n"), '<br />', preg_replace(array("/\s\s+/", "/\r\r+/", "/\n\n+/"), '<br />', trim(str_replace($find, $replace, $format))));]]></search>
      <add position="before"><![CDATA[
        foreach ($custom_fields as $custom_field) {
          if (isset($order_info['shipping_custom_field'][$custom_field['custom_field_id']])){
            $format = str_replace('{custom_field_' . $custom_field['custom_field_id'] . '}', $order_info['shipping_custom_field'][$custom_field['custom_field_id']], $format);
          }
        }
      ]]></add>
    </operation>
  </file>
</modification>